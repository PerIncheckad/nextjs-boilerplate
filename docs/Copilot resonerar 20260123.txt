I'll help you fix these three related issues with damage display for vehicles. Let me start by exploring the repository to understand the codebase structure.

Find TypeScript files in the repository
View repository
Now let me explore the key files mentioned in the problem statement:

View lib/vehicle-status.ts:1-100
View app/api/vehicle-info/route.ts
View lib/damages.ts
Let me search for the formatDamageType function and understand how it's used:

Search formatDamageType
Search normalizeDamageTypeForKey
Now let me view the relevant sections of vehicle-status.ts to understand the current implementation:

View lib/vehicle-status.ts:618-650
View lib/vehicle-status.ts:430-460
View lib/vehicle-status.ts:2140-2170
Let me view more of the vehicle-status.ts file to understand the matching logic:

View lib/vehicle-status.ts:1050-1120
View lib/vehicle-status.ts:1410-1440
View lib/vehicle-status.ts:1820-1880
View lib/vehicle-status.ts:2280-2310
Now let me look at the section where the damage text is built to understand where the formatting needs to be applied:

View lib/vehicle-status.ts:2080-2150
Find package.json to understand project structure
Now let me check the tests to understand how the code is tested:

Find test files
View package.json
Now let me understand the complete picture by looking at more context from vehicle-status.ts:

View lib/vehicle-status.ts:2170-2200
Check how long vehicle-status.ts is
Now I have a good understanding of the problem. Let me create a plan and report progress:

Progress update: Initial plan for damage display fixes
Now let's start fixing the issues. Let me start with Problem 1 - applying formatDamageType() to raw damage types:

View lib/vehicle-status.ts:2084-2106
View lib/vehicle-status.ts:2125-2135
Now let me apply the fixes. I'll start by fixing all three problems in lib/vehicle-status.ts:

Edit lib/vehicle-status.ts
Edit lib/vehicle-status.ts
Now let me fix the HISTORIK matching logic. First, let me look at the current code more carefully:

View lib/vehicle-status.ts:1416-1426
The issue here is that damage.skadetyp has already been formatted (e.g., "Fälgskada Sommarhjul") but cd.damage_type might still be in raw format (e.g., "FALGSKADA_SOMMARHJUL"). Let me fix this by normalizing both sides:

Edit lib/vehicle-status.ts
Now let me fix the same issue in the second location:

View lib/vehicle-status.ts:2289-2301
Edit lib/vehicle-status.ts
Now let me fix the same issue in app/api/vehicle-info/route.ts:

View app/api/vehicle-info/route.ts:270-295
Edit app/api/vehicle-info/route.ts
Now let me verify the changes by building the project:

Build the project to check for TypeScript errors
Let me install dependencies first:

Install dependencies
Now let me try building again:

Build the project
Good! The build succeeds with only a dynamic server usage warning which is expected for API routes. Now let me commit the changes:

Progress update: Fix damage type formatting and matching logic
Now let me verify the changes were applied correctly by viewing the modified sections:

View lib/vehicle-status.ts:2084-2092
View lib/vehicle-status.ts:2125-2135
View lib/vehicle-status.ts:1416-1436
Let me look at the actual changes where I applied formatDamageType:

View lib/vehicle-status.ts:2092-2106
View lib/vehicle-status.ts:2135-2148
Perfect! Now let me check the changes in the API route:

View app/api/vehicle-info/route.ts:279-294
Excellent! All the changes look good. Now let me request a code review:

Review changes with Copilot code review
The code review identified one valid concern about code duplication. Let me address that by extracting the matching logic into a helper function:

View lib/vehicle-status.ts:450-465
Edit lib/vehicle-status.ts
Now let me update the first location to use the new helper function:

Edit lib/vehicle-status.ts
Now let me find and update the second location:

View lib/vehicle-status.ts:2300-2325
Edit lib/vehicle-status.ts
Now let me rebuild to make sure everything still compiles correctly:

Build the project after refactoring
Perfect! The build succeeds. Now let me commit these refactoring changes:

Progress update: Refactor: Extract BUHS damage matching logic into helper function
Great! Now let me run the security scan with CodeQL:

Run CodeQL security scan on changed files
Excellent! No security issues found. Now let me update the final progress:

Progress update: Update progress - all fixes complete and validated
Perfect! Let me create a summary of the changes for documentation purposes:

Summary
I have successfully implemented all three fixes for the damage display issues:

✅ Problem 1: Raw damage_type formatting
Fixed by applying formatDamageType() function to convert uppercase underscore format (e.g., "FALGSKADA_SOMMARHJUL") to human-readable format (e.g., "Fälgskada Sommarhjul"):

In lib/vehicle-status.ts for documented/existing damages (line 2099)
In lib/vehicle-status.ts for not_found damages (line 2142)
In app/api/vehicle-info/route.ts for the /check page API (line 282)
✅ Problem 2: "(BUHS)" suffix incorrectly shown on handled damages
Fixed by ensuring not_found damages use the formatted damage_type from checkin_damages instead of the raw legacy text. This removes the incorrect "(BUHS)" suffix since these damages WERE handled (just couldn't be documented).

✅ Problem 3: Only 1/3 damages shown in HISTORIK section
Fixed by:

Normalizing both sides of the comparison using normalizeDamageTypeForKey()
Removing "(BUHS)" suffix before comparison
Extracting the matching logic into a reusable helper function matchBuhsDamageForCheckin() to avoid code duplication
Testing Results
✅ Build succeeds without TypeScript errors
✅ Code review feedback addressed (extracted duplicated logic into helper function)
✅ CodeQL security scan passed with 0 alerts
Expected Impact for LRA75R
Before:

SKADOR section: "FALGSKADA_SOMMARHJUL (BUHS)" ❌
HISTORIK section: Only 1/3 damages shown ❌
/check page: Raw "FALGSKADA_SOMMARHJUL" format ❌
After:

SKADOR section: "Fälgskada Sommarhjul" with proper status ✅
HISTORIK section: All 3 damages shown in checkin history ✅
/check page: "Fälgskada Sommarhjul" properly formatted ✅
The changes are minimal and surgical, affecting only the specific display and matching logic without altering the underlying data structures or business logic.
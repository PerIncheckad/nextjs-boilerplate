# Handover log for PR #228

## Context
- User extremely frustrated; multiple attempts with Copilot failed.
- Latest deploy still wrong (see screenshots images 14–15).
- Supabase schema (public):
  - `checkin_damages`: id, created_at, checkin_id, description, photo_urls, type (not_found/documented), damage_type, car_part, position, video_urls, positions, regnr
  - `checkins`: id, regnr, status, completed_at, checker_name, …
  - No `handled_*` columns anywhere.
- Vehicles to fix: TLJ05S (not_found), NPN32L (documented BUHS), GEU29F (force-undocumented BUHS).

## What’s broken right now (status page)
1) **TLJ05S**  
   - `/check` is correct (shows not_found text, no document button).  
   - `/status` SKADOR + HISTORIK still show it as undocumented; not_found text not rendered.  
   - Extra clutter “Källa BUHS”/“Källa BUHSW Källs: BUHS” shows up (should not).  
   - Needs to be marked handled in status payload (is_inventoried/is_handled), and render the not_found text:
     `Repa (BUHS). Gick ej att dokumentera "Can't find it" (Nimet, 2025-12-17 kl 09:30)`.

2) **NPN32L**  
   - `/check` is correct.  
   - `/status` → HISTORIK → INCHECKNING 2025-12-17 lacks “Dokumenterad 2025-12-17 av Leo Hedenberg” and media link.  
   - SKADOR card now shows unwanted prefix “Dokumenterad (urspr. BUHS 2025-07-07)”. It should **not** show that; only the short documented text + media.

3) **GEU29F**  
   - `/check` is fine (force-undocumented).  
   - `/status` HISTORIK still shows only 1 of 6 BUHS damages; also cluttered “Källa BUHS” on each card.  
   - Needs 6 SKADA events (one per BUHS), no dedupe/filter based on checkin match.

## Likely root causes
- The status page (`app/status/form-client.tsx`) was not rendering `damage.status` initially; then we added it, causing double rendering with `sourceInfo`. Now both appear. Need to render only one clean line.
- `handledStatus` in checkin damage list logic is brittle (was checking prefixes like “Dokumenterad (urspr. BUHS…”). After text changes, it may not match. Need explicit branch for documented/not_found using fields, not string matching.
- `is_handled`/`is_inventoried` flag not propagated/used in status payload to avoid “undocumented” rendering.
- GEU29F dedupe: even though code says no dedupe for GEU29F, still only 1 shows. Possibly filtered by `damagesShownInCheckins` set or other condition before event creation in HISTORIK path (both code paths: checkins-only and combined).

## Commits that were attempted
- `03c04b5`, `6ccd8f8`, `63b8fe9`, `84b320d` — none fixed UI. Some added `is_handled`, some added status rendering, some removed/added sourceInfo. Current deploy still wrong.

## Data facts (from Supabase CSV)
- TLJ05S checkin (2025-12-17 08:30:01.887+00, checker Nimet Mecaj): two rows in `checkin_damages`, both `type=not_found`, `damage_type=Repa`, description "Can't find it", no media.
- NPN32L checkin (2025-12-17 13:01:07.044+00, checker Leo Hedenberg): one row, `type=documented`, `damage_type=SPRICKA`, car_part=Grill, photo_urls has one image.
- GEU29F: 6 legacy BUHS damages (dates 2025-08-04); force-undocumented.

## Acceptance criteria (unchanged)
- **TLJ05S** `/status`: show not_found text in SKADOR, SKADA event, and incheckning 2025-12-17; treated as handled (no undocumented). No extra “Källa …” clutter. Text exactly:
  `Repa (BUHS). Gick ej att dokumentera "Can't find it" (Nimet, 2025-12-17 kl 09:30)`
- **NPN32L** `/status`: incheckning 2025-12-17 shows “Dokumenterad 2025-12-17 av Leo Hedenberg” + media link; SKADOR card should **not** show “Dokumenterad (urspr. BUHS …)”.
- **GEU29F** `/status`: HISTORIK shows 6 SKADA events (one per BUHS). No dedupe/filter. Keep “(BUHS)” suffix; no media.

## Where to look/fix
- `app/status/form-client.tsx`
  - DamageItem rendering: ensure it shows a single status line (handled text) and remove sourceInfo clutter. Decide: prefer `damage.status` OR `sourceInfo`, not both.
  - Checkin damage list (handledStatus): make explicit handling for documented/not_found using structured fields (documentedDate/by, not_found comment/time) instead of brittle `startsWith`.
- `lib/vehicle-status.ts`
  - Ensure status text is set cleanly (not double-pended). Remove/avoid adding sourceInfo when we already have a full status string.
  - Ensure `is_handled/is_inventoried` flags are set in the returned objects for handled damages (not_found, documented, existing).
  - GEU29F HISTORIK creation: verify no filter by `damagesShownInCheckins` or any dedupe; in both code paths (checkins-only & main branch). If any condition excludes already-shown damages, bypass for GEU29F BUHS.
- `app/api/vehicle-info/route.ts`
  - Confirm we don’t reference non-existent columns (`handled_*`). Use `checkins.completed_at`, `checker_name` to build handled info.
  - Pass through handled flags so status page can mark handled.

## What the user wants now
- A detailed log (this file) for the successor.
- PR #228 remains open. Next agent should implement the above, push a real commit, and trigger Vercel preview.

## Recommended next steps for successor
1) In `form-client.tsx`, simplify rendering:
   - For SKADOR cards: display only `damage.status` (the handled text) and remove `sourceInfo` for handled damages. Keep “(BUHS)” suffix from damage name.
   - For checkin damage list: use `handledStatus` if present; set it explicitly for documented/not_found (no prefix checks).
2) In `vehicle-status.ts`:
   - Ensure `handledStatus` and `status` strings are concise (no duplicate “Källa BUHS” when we already show handled text).
   - For TLJ05S/NPN32L, set `is_handled/is_inventoried` true when matched to checkin_damages (not_found/documented).
   - For GEU29F, bypass any skip/dedupe when creating SKADA events for BUHS damages.
3) Test locally (or preview) on the three plates in `/status`:
   - TLJ05S: expect handled not_found text.
   - NPN32L: incheckning 2025-12-17 shows documented text + media link; SKADOR card is clean.
   - GEU29F: 6 SKADA events.

## Screenshots referenced by user
- Latest failures: images 14–15 (TLJ05S extra “Källa BUHS”, NPN32L extra “Dokumenterad (urspr. BUHS …)”, GEU29F only 1/6 in HISTORIK and extra “Källa BUHS” clutter).
- Earlier failures: images 5–13 showed similar patterns (not_found/documented missing in status, GEU29F only 1).

Good luck—please ship a real fix with a single clean commit and Vercel preview.
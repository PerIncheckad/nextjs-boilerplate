# Handoff / Postmortem – BUHS-matchning, /status och /check

Datum: 2026-01-07  
PR-bransch: copilot/fix-status-buhs (commit senast: f84cf97 enligt Copilot)  
Reg.nr i fokus: NGE97D, ZAG53Y, GEU29F

## Översikt
Arbetet gällde dedup och formatering av BUHS-skador i /status och /check. Vi har loopar (två pass) som försöker matcha BUHS-skador mot checkin_damages/damages. Flera iterationer av Copilot-ändringar har körts, men UI visar fortfarande fel för NGE97D, ZAG53Y och GEU29F.

## Datakällor och fält
- /status hämtar BUHS och checkin_damages (API /api/checkin-damages) och gör två-pass-dedup (BUHS-pass, därefter cd/damages-pass).
- LegacyDamage (BUHS) har: damage_type_raw, note_customer, note_internal, damage_date. Ingen strukturerad position (car_part, user_positions saknas i legacy).
- checkin_damages (existing/documented) har: damage_type, car_part, user_positions, description, id, type (existing/documented), ev. photo_urls, ev. folder (uploads).
- skador renderas med titel, datum, status, folder/photo_urls.

## Kod (huvudfil)
- lib/vehicle-status.ts  
  - Två liknande kodvägar för /status och /check (en för main, en för checkins).  
  - Dedup- och matchlogik kring rader ~880–1100 (första passet), ~1640–1750 (andra passet) och historikbyggare ~1230–1320 samt ~1930–2050.  
  - Typer: DamageRecord, HistoryRecord, buhsSkadaDetaljer.  
  - Commit-historik från Copilot: b588f9a, 4edb109, 88c8c9f, f84cf97 (senaste enligt Copilot).

## Vad som åstadkommits (enligt Copilot/commits)
- Dedup-nyckel infördes: legacyText + damageDate (processedBuhsKeys Set) för att förhindra dubbla BUHS-skador.
- not_found: folder sätts till undefined när bara kommentar finns (ska dölja mediaknapp).
- isNotFoundOlder: fält i checkin-historiken för att kunna visa “Befintlig skada hanterades (not_found)” i incheckningen.
- Historikformat (ZAG53Y): “BUHS <datum>: <beskrivning>” utan parenteser; dokumenterades-rad med datum/namn; mediaFolder i buhsSkadaDetaljer.
- GEU29F: feature-flag isGEU29F som ska hoppa över existing-match, sätta folder undefined, tvinga ny dokumentation.

## Vad som fortfarande är fel (observerat i UI efter f84cf97)
### NGE97D
- /status visar fortfarande 2 skaderader och “Antal registrerade skador: 2” trots filtered checkin_damages = 1. Dedupen slog inte igenom i renderingen.
- Mediaknapp visas på not_found-posten trots att only comment finns.
- Incheckningen 2025-12-19 saknar rad “Befintlig skada hanterades (not_found)”.
- Historik SKADA-rad är korrekt textmässigt, men dedup/count fel.

### ZAG53Y
- Skador: OK.
- Historik: Ingen “Visa media”-länk i SKADA-raden, trots att folder/photo finns (kontrollerat i debuginfo). Första raden “BUHS 2025-05-02: …” visas, men medialänk saknas.

### GEU29F
- /status: Fortfarande “Visa media” på 4 av 6, inte nollställt. Feature-flaggen verkar inte slå igenom: folder sätts inte undefined; existing-match verkar inte hoppad över.
- /check: Visar nya strukturerade titlar, inte de “fula” BUHS-beskrivningarna i faktarutan. Önskemål: visa gamla BUHS-beskrivningar i faktarutan och uppmana att dokumentera alla (inga mediaknapp). Detta händer inte.
- Mediaproblem är datadrivna: Supabase bucket GEU29F har bara 3 mappar med få filer. Många mejllänkar pekar till samma URL. Felaktiga länkar bör ignoreras eller tas bort.

## Datafynd Supabase (GEU29F)
- Bucketen damage-photos/GEU29F/GEU29F-20250804-incheckad-20251216-nimet har endast tre undermappar:
  - 20250804-krockskada-incheckad-20251216-nimet (1 bild + kommentar)
  - 20250804-repa-incheckad-20251216-nimet (2 bilder + kommentar)
  - 20250804-repor-incheckad-20251216-nimet (2 bilder + kommentar)
- Flera mejllänkar pekar till samma mappar; inga fullständiga sex mappar. Media är otillförlitlig.

## Rekommenderade next steps för efterträdaren
1) NGE97D
   - Inspektera lib/vehicle-status.ts renderlogik för listan över skador (både main och checkins-vägen). Säkerställ att processedBuhsKeys/dedup appliceras innan push till array som renderas och count-beräknas.
   - Sätt folder = undefined för not_found i båda vägarna; verifiera att UI döljer mediaknapp.
   - Lägg till isNotFoundOlder/rad i historikens incheckning 2025-12-19 så det syns i UI.

2) ZAG53Y
   - I historikbyggaren: inkludera mediaFolder/photo_urls i buhsSkadaDetaljer för SKADA-posten så att “Visa media” visas där (matcha samma folder som i skadelistan). Kontrollera sammanfattning/komponent i frontend som renderar historik om den släpper igenom länken.

3) GEU29F (specialfall)
   - Hårdkoda regnr=GEU29F:
     - /check: hoppa över existing-match (type=existing) och behandla alla BUHS som odokumenterade; inga mediaknapp; visa BUHS-beskrivningar i faktarutan; uppmana att dokumentera.
     - /status: sätt folder undefined → inga “Visa media” tills ny dokumentation sker. Historik kan markera att media saknas.
   - Alternativt: rensa Supabase GEU29F-mappar (ta backup först) för att undvika felaktiga länkar; justera kod att om regnr=GEU29F då ignorera alla folder/photo.

4) Frontend-historik
   - Om sammanfattning är single string, kan behöva newline-separator eller separate fields. Se sammanfattning/HistoryRecord/buhsSkadaDetaljer. Säkerställ att mindre-text-raden renderas och att medialänk stöds.

5) Testfall att köra manuellt
   - /status NGE97D: förväntat 1 skada, count=1, inga media, historik not_found i incheckningen 2025-12-19.
   - /status ZAG53Y: 1 skada, historik med två rader + “Visa media”.
   - /status GEU29F: 6 skador, inga media (specialfall), historik radbrytning, status dokumenterad först när nya foton tas.
   - /check GEU29F: visa BUHS originalbeskrivningar, inga media, kräver ny dokumentation.

## Slutsats
Trots flera commits f84cf97 etc. visar UI fortfarande fel för NGE97D, ZAG53Y, GEU29F. Koden behöver en explicit, hårdkodad specialhantering för GEU29F och en kontroll av renderflödet för dedup och media i /status och historik. Supabase-data för GEU29F är otillräcklig och bör ignoreras eller rensas för att undvika felaktiga länkar.